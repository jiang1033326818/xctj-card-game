<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÇ∏ÈáëËä± - XCTJÂç°ÁâåÊ∏∏Êàè</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'ÂæÆËΩØÈõÖÈªë', Arial, sans-serif;
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 50%, #FFD700 100%);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: linear-gradient(45deg, #FF6B6B, #EE5A24);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(238, 90, 36, 0.4);
        }

        .game-title {
            color: #FFD700;
            font-size: 1.8rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
        }

        .balance {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-area {
            flex: 3;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            color: white;
            backdrop-filter: blur(10px);
        }

        .players-area {
            flex: 1;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            color: white;
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.4rem;
            color: #FFD700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #FFD700;
        }

        .room-setup {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: rgba(255, 255, 255, 0.9);
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #0D47A1);
        }

        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #E65100);
        }

        .btn-warning:hover {
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #F44336, #B71C1C);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        .game-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-label {
            font-weight: bold;
        }

        .info-value {
            color: #FFD700;
        }

        .player-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .player-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name {
            font-weight: bold;
        }

        .player-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .status-waiting {
            background: #2196F3;
        }

        .status-playing {
            background: #4CAF50;
        }

        .status-folded {
            background: #FF9800;
        }

        .status-lost {
            background: #F44336;
        }

        .cards-area {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .card {
            width: 80px;
            height: 120px;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .card.red {
            color: #DC143C;
        }

        .card.black {
            color: #000;
        }

        .card-back {
            background: linear-gradient(135deg, #1e5799 0%, #207cca 50%, #2989d8 51%, #7db9e8 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .actions-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .pot-area {
            text-align: center;
            margin: 20px 0;
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFD700;
        }

        .current-player {
            background: rgba(255, 215, 0, 0.3) !important;
            border: 2px solid #FFD700;
        }

        .hidden {
            display: none;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.3);
            color: #fff;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.3);
            color: #fff;
        }

        .message.info {
            background: rgba(33, 150, 243, 0.3);
            color: #fff;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .card {
                width: 60px;
                height: 90px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="header-left">
                <button class="back-btn" onclick="goHome()">üîô ËøîÂõûÂ§ßÂéÖ</button>
                <div class="game-title">üÉè ÁÇ∏ÈáëËä±</div>
            </div>
            <div class="user-info">
                <div>
                    <span class="welcome">Ê¨¢ËøéÔºå<span id="username">Âä†ËΩΩ‰∏≠...</span></span>
                </div>
                <div>
                    <span class="balance">‰ΩôÈ¢ù: ¬•<span id="balance">0</span></span>
                </div>
                <div>
                    <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫ÁôªÂΩï</button>
                </div>
            </div>
        </div>

        <div id="loading" class="message info">
            Ê≠£Âú®Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ...
        </div>

        <div id="main-content" class="main-content hidden">
            <!-- Ê∏∏ÊàèÂå∫Âüü -->
            <div class="game-area">
                <h2 class="section-title">Ê∏∏ÊàèÂå∫Âüü</h2>
                
                <!-- ÊàøÈó¥ËÆæÁΩÆ -->
                <div id="room-setup" class="room-setup">
                    <h3>ÂàõÂª∫ÊàøÈó¥</h3>
                    <div class="form-group">
                        <label for="room-name">ÊàøÈó¥ÂêçÁß∞</label>
                        <input type="text" id="room-name" placeholder="ËæìÂÖ•ÊàøÈó¥ÂêçÁß∞">
                    </div>
                    <div class="form-group">
                        <label for="chip-amount">Êê∫Â∏¶Á≠πÁ†ÅÈáè</label>
                        <input type="number" id="chip-amount" placeholder="ËæìÂÖ•Êê∫Â∏¶Á≠πÁ†ÅÈáè" value="1000">
                    </div>
                    <div class="form-group">
                        <label for="max-bet">ÊúÄÂ§ß‰∏ãÊ≥®Èáè</label>
                        <input type="number" id="max-bet" placeholder="ËæìÂÖ•ÊúÄÂ§ß‰∏ãÊ≥®Èáè" value="500">
                    </div>
                    <div class="form-group">
                        <label for="max-meng-bet">ÊúÄÂ§ßÁÑñÁâå‰∏ãÊ≥®Èáè</label>
                        <input type="number" id="max-meng-bet" placeholder="ËæìÂÖ•ÊúÄÂ§ßÁÑñÁâå‰∏ãÊ≥®Èáè" value="100">
                    </div>
                    <div class="form-group">
                        <label for="base-bet">Â∫ïÊ≥®Èáè</label>
                        <input type="number" id="base-bet" placeholder="ËæìÂÖ•Â∫ïÊ≥®Èáè" value="10">
                    </div>
                    <button class="btn btn-primary" onclick="createRoom()">ÂàõÂª∫ÊàøÈó¥</button>
                </div>

                <!-- Âä†ÂÖ•ÊàøÈó¥ -->
                <div id="join-room" class="room-setup hidden">
                    <h3>Âä†ÂÖ•ÊàøÈó¥</h3>
                    <div class="form-group">
                        <label for="room-id">ÊàøÈó¥ID</label>
                        <input type="text" id="room-id" placeholder="ËæìÂÖ•ÊàøÈó¥ID">
                    </div>
                    <button class="btn btn-primary" onclick="joinRoom()">Âä†ÂÖ•ÊàøÈó¥</button>
                </div>

                <!-- Ê∏∏Êàè‰ø°ÊÅØ -->
                <div id="game-info" class="game-info hidden">
                    <div class="info-item">
                        <span class="info-label">ÊàøÈó¥ID:</span>
                        <span class="info-value" id="room-id-display"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ÊàøÈó¥ÂêçÁß∞:</span>
                        <span class="info-value" id="room-name-display"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ÂΩìÂâçËΩÆÊ¨°:</span>
                        <span class="info-value" id="current-round">1</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ÂΩìÂâçÊ≥®È¢ù:</span>
                        <span class="info-value" id="current-bet">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Â•ñÊ±†:</span>
                        <span class="info-value" id="pot">0</span>
                    </div>
                </div>

                <!-- Â∫ïÁâåÂå∫Âüü -->
                <div id="cards-area" class="cards-area hidden">
                    <div class="card card-back">?</div>
                    <div class="card card-back">?</div>
                    <div class="card card-back">?</div>
                </div>

                <!-- Â•ñÊ±† -->
                <div id="pot-area" class="pot-area hidden">
                    Â•ñÊ±†: ¬•<span id="pot-amount">0</span>
                </div>

                <!-- Êìç‰ΩúÂå∫Âüü -->
                <div id="actions-area" class="actions-area hidden">
                    <h3>ÊÇ®ÁöÑÊìç‰Ωú</h3>
                    <div class="action-buttons">
                        <button class="btn" onclick="playerAction('call')">Ë∑üÊ≥®</button>
                        <button class="btn btn-primary" onclick="showRaiseModal()">Âä†Ê≥®</button>
                        <button class="btn btn-warning" onclick="playerAction('meng')">ÁÑñÁâå</button>
                        <button class="btn" onclick="showCompareModal()">ÊØîÁâå</button>
                        <button class="btn btn-danger" onclick="playerAction('fold')">ÂºÉÁâå</button>
                    </div>
                </div>
            </div>

            <!-- Áé©ÂÆ∂Âå∫Âüü -->
            <div class="players-area">
                <h2 class="section-title">Áé©ÂÆ∂ÂàóË°®</h2>
                <div id="player-list" class="player-list">
                    <div class="message info">Á≠âÂæÖÁé©ÂÆ∂Âä†ÂÖ•...</div>
                </div>
                
                <div id="room-controls" class="hidden">
                    <button class="btn btn-primary" onclick="startGame()">ÂºÄÂßãÊ∏∏Êàè</button>
                </div>
            </div>
        </div>

        <!-- Âä†Ê≥®Ê®°ÊÄÅÊ°Ü -->
        <div id="raise-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Âä†Ê≥®</h3>
                    <span class="close-btn" onclick="closeRaiseModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="raise-amount">Âä†Ê≥®ÈáëÈ¢ù</label>
                        <input type="number" id="raise-amount" placeholder="ËæìÂÖ•Âä†Ê≥®ÈáëÈ¢ù">
                    </div>
                    <button class="btn btn-primary" onclick="confirmRaise()">Á°ÆËÆ§Âä†Ê≥®</button>
                </div>
            </div>
        </div>

        <!-- ÊØîÁâåÊ®°ÊÄÅÊ°Ü -->
        <div id="compare-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ÈÄâÊã©Ë¶ÅÊØîÁâåÁöÑÁé©ÂÆ∂</h3>
                    <span class="close-btn" onclick="closeCompareModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="compare-player-list">
                        <!-- Áé©ÂÆ∂ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê∂àÊÅØÊèêÁ§∫ -->
        <div id="message-area"></div>
    </div>

    <script>
        let currentUser = null;
        let currentRoom = null;
        let roomId = null;

        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        window.addEventListener('load', async () => {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const response = await fetch('/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    
                    document.getElementById('username').textContent = user.username;
                    document.getElementById('balance').textContent = user.balance;
                    
                    // ÊòæÁ§∫‰∏ªË¶ÅÂÜÖÂÆπ
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                } else {
                    // ÁôªÂΩïÂ§±ÊïàÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', error);
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        });

        // ËøîÂõûÂ§ßÂéÖ
        function goHome() {
            window.location.href = '/index.html';
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }

        // ÂàõÂª∫ÊàøÈó¥
        async function createRoom() {
            const roomName = document.getElementById('room-name').value;
            const chipAmount = parseInt(document.getElementById('chip-amount').value);
            const maxBet = parseInt(document.getElementById('max-bet').value);
            const maxMengBet = parseInt(document.getElementById('max-meng-bet').value);
            const baseBet = parseInt(document.getElementById('base-bet').value);

            if (!roomName || chipAmount <= 0 || maxBet <= 0 || maxMengBet <= 0 || baseBet <= 0) {
                showMessage('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÊàøÈó¥‰ø°ÊÅØ', 'error');
                return;
            }

            if (maxMengBet > maxBet) {
                showMessage('ÊúÄÂ§ßÁÑñÁâå‰∏ãÊ≥®Èáè‰∏çËÉΩË∂ÖËøáÊúÄÂ§ß‰∏ãÊ≥®Èáè', 'error');
                return;
            }

            if (baseBet > chipAmount) {
                showMessage('Â∫ïÊ≥®Èáè‰∏çËÉΩË∂ÖËøáÊê∫Â∏¶Á≠πÁ†ÅÈáè', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/zhajinhua/create-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roomName,
                        chipAmount,
                        maxBet,
                        maxMengBet,
                        baseBet
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    roomId = result.room_id;
                    showMessage('ÊàøÈó¥ÂàõÂª∫ÊàêÂäü', 'success');
                    document.getElementById('room-setup').classList.add('hidden');
                    document.getElementById('join-room').classList.add('hidden');
                    document.getElementById('game-info').classList.remove('hidden');
                    document.getElementById('room-id-display').textContent = roomId;
                    document.getElementById('room-name-display').textContent = roomName;
                    
                    // ÂºÄÂßãËΩÆËØ¢ÊàøÈó¥‰ø°ÊÅØ
                    pollRoomInfo();
                } else {
                    showMessage(result.error || 'ÂàõÂª∫ÊàøÈó¥Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('ÂàõÂª∫ÊàøÈó¥ÈîôËØØ:', error);
                showMessage('ÂàõÂª∫ÊàøÈó¥Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            }
        }

        // Âä†ÂÖ•ÊàøÈó¥
        async function joinRoom() {
            const roomIdInput = document.getElementById('room-id').value;
            
            if (!roomIdInput) {
                showMessage('ËØ∑ËæìÂÖ•ÊàøÈó¥ID', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/zhajinhua/join-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roomId: roomIdInput
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    roomId = roomIdInput;
                    showMessage('Âä†ÂÖ•ÊàøÈó¥ÊàêÂäü', 'success');
                    document.getElementById('room-setup').classList.add('hidden');
                    document.getElementById('join-room').classList.add('hidden');
                    document.getElementById('game-info').classList.remove('hidden');
                    document.getElementById('room-id-display').textContent = roomId;
                    
                    // ÂºÄÂßãËΩÆËØ¢ÊàøÈó¥‰ø°ÊÅØ
                    pollRoomInfo();
                } else {
                    showMessage(result.error || 'Âä†ÂÖ•ÊàøÈó¥Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âä†ÂÖ•ÊàøÈó¥ÈîôËØØ:', error);
                showMessage('Âä†ÂÖ•ÊàøÈó¥Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            }
        }

        // ËΩÆËØ¢ÊàøÈó¥‰ø°ÊÅØ
        function pollRoomInfo() {
            if (roomId) {
                getRoomInfo();
                setTimeout(pollRoomInfo, 3000); // ÊØè3ÁßíËΩÆËØ¢‰∏ÄÊ¨°
            }
        }

        // Ëé∑ÂèñÊàøÈó¥‰ø°ÊÅØ
        async function getRoomInfo() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/zhajinhua/room-info?roomId=${roomId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    currentRoom = result.room;
                    updateRoomDisplay();
                } else {
                    showMessage(result.error || 'Ëé∑ÂèñÊàøÈó¥‰ø°ÊÅØÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÊàøÈó¥‰ø°ÊÅØÈîôËØØ:', error);
            }
        }

        // Êõ¥Êñ∞ÊàøÈó¥ÊòæÁ§∫
        function updateRoomDisplay() {
            if (!currentRoom) return;

            // Êõ¥Êñ∞ÊàøÈó¥‰ø°ÊÅØ
            document.getElementById('room-name-display').textContent = currentRoom.room_name;
            document.getElementById('current-round').textContent = currentRoom.current_round;
            document.getElementById('current-bet').textContent = currentRoom.current_bet;
            document.getElementById('pot').textContent = currentRoom.pot;
            document.getElementById('pot-amount').textContent = currentRoom.pot;

            // Êõ¥Êñ∞Áé©ÂÆ∂ÂàóË°®
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            
            if (currentRoom.players.length === 0) {
                playerList.innerHTML = '<div class="message info">Á≠âÂæÖÁé©ÂÆ∂Âä†ÂÖ•...</div>';
            } else {
                currentRoom.players.forEach(player => {
                    const playerItem = document.createElement('div');
                    playerItem.className = `player-item ${player.username === currentUser.username ? 'current-player' : ''}`;
                    
                    let statusClass = 'status-waiting';
                    let statusText = 'Á≠âÂæÖ‰∏≠';
                    
                    if (player.status === 'playing') {
                        statusClass = 'status-playing';
                        statusText = 'Ê∏∏Êàè‰∏≠';
                    } else if (player.status === 'folded') {
                        statusClass = 'status-folded';
                        statusText = 'Â∑≤ÂºÉÁâå';
                    } else if (player.status === 'lost') {
                        statusClass = 'status-lost';
                        statusText = 'Â∑≤Ëæì';
                    }
                    
                    playerItem.innerHTML = `
                        <div>
                            <div class="player-name">${player.username} ${player.is_creator ? '(Êàø‰∏ª)' : ''}</div>
                            <div>Á≠πÁ†Å: ¬•${player.chips}</div>
                        </div>
                        <div class="player-status ${statusClass}">${statusText}</div>
                    `;
                    
                    playerList.appendChild(playerItem);
                });
            }

            // ÊòæÁ§∫Êàø‰∏ªÊéßÂà∂ÊåâÈíÆ
            const roomControls = document.getElementById('room-controls');
            const isCreator = currentRoom.creator === currentUser.username;
            const isWaiting = currentRoom.game_status === 'waiting';
            
            if (isCreator && isWaiting) {
                roomControls.classList.remove('hidden');
            } else {
                roomControls.classList.add('hidden');
            }

            // ÊòæÁ§∫Ê∏∏ÊàèÁõ∏ÂÖ≥ÂÖÉÁ¥†
            if (currentRoom.game_status === 'playing') {
                document.getElementById('cards-area').classList.remove('hidden');
                document.getElementById('pot-area').classList.remove('hidden');
                
                // Â¶ÇÊûúÊòØÂΩìÂâçÁé©ÂÆ∂ÁöÑÂõûÂêàÔºåÊòæÁ§∫Êìç‰ΩúÊåâÈíÆ
                const currentPlayerIndex = currentRoom.current_player_index;
                const currentPlayer = currentRoom.players[currentPlayerIndex];
                
                if (currentPlayer && currentPlayer.username === currentUser.username) {
                    document.getElementById('actions-area').classList.remove('hidden');
                } else {
                    document.getElementById('actions-area').classList.add('hidden');
                }
            } else {
                document.getElementById('cards-area').classList.add('hidden');
                document.getElementById('pot-area').classList.add('hidden');
                document.getElementById('actions-area').classList.add('hidden');
            }

            // Ê∏∏ÊàèÁªìÊùüÂ§ÑÁêÜ
            if (currentRoom.game_status === 'finished') {
                showMessage(`${currentRoom.winner} Ëé∑Âæó‰∫ÜÊ∏∏ÊàèËÉúÂà©ÔºåËµ¢Âæó ¬•${currentRoom.pot}!`, 'success');
            }
        }

        // ÂºÄÂßãÊ∏∏Êàè
        async function startGame() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/zhajinhua/start-game', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roomId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('Ê∏∏ÊàèÂºÄÂßã', 'success');
                    currentRoom = result.room;
                    updateRoomDisplay();
                } else {
                    showMessage(result.error || 'ÂºÄÂßãÊ∏∏ÊàèÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('ÂºÄÂßãÊ∏∏ÊàèÈîôËØØ:', error);
                showMessage('ÂºÄÂßãÊ∏∏ÊàèÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            }
        }

        // Áé©ÂÆ∂Êìç‰Ωú
        async function playerAction(action, betAmount = null, targetPlayer = null) {
            try {
                const token = localStorage.getItem('token');
                const requestBody = {
                    roomId,
                    action
                };
                
                if (betAmount !== null) {
                    requestBody.betAmount = betAmount;
                }
                
                if (targetPlayer !== null) {
                    requestBody.targetPlayer = targetPlayer;
                }
                
                const response = await fetch('/api/zhajinhua/player-action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    if (result.room) {
                        currentRoom = result.room;
                        updateRoomDisplay();
                    }
                } else {
                    showMessage(result.error || 'Êìç‰ΩúÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Áé©ÂÆ∂Êìç‰ΩúÈîôËØØ:', error);
                showMessage('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            }
        }

        // ÊòæÁ§∫Âä†Ê≥®Ê®°ÊÄÅÊ°Ü
        function showRaiseModal() {
            document.getElementById('raise-modal').classList.remove('hidden');
        }

        // ÂÖ≥Èó≠Âä†Ê≥®Ê®°ÊÄÅÊ°Ü
        function closeRaiseModal() {
            document.getElementById('raise-modal').classList.add('hidden');
        }

        // Á°ÆËÆ§Âä†Ê≥®
        function confirmRaise() {
            const raiseAmount = parseInt(document.getElementById('raise-amount').value);
            
            if (isNaN(raiseAmount) || raiseAmount <= 0) {
                showMessage('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂä†Ê≥®ÈáëÈ¢ù', 'error');
                return;
            }
            
            playerAction('raise', raiseAmount);
            closeRaiseModal();
            document.getElementById('raise-amount').value = '';
        }

        // ÊòæÁ§∫ÊØîÁâåÊ®°ÊÄÅÊ°Ü
        function showCompareModal() {
            if (!currentRoom || currentRoom.players.length < 2) {
                showMessage('Ê≤°ÊúâË∂≥Â§üÁöÑÁé©ÂÆ∂ËøõË°åÊØîÁâå', 'error');
                return;
            }
            
            const comparePlayerList = document.getElementById('compare-player-list');
            comparePlayerList.innerHTML = '';
            
            currentRoom.players.forEach(player => {
                // ÊéíÈô§Ëá™Â∑±ÂíåÂ∑≤ÂºÉÁâå/Â∑≤ËæìÁöÑÁé©ÂÆ∂
                if (player.username !== currentUser.username && 
                    player.status === 'playing') {
                    const playerButton = document.createElement('button');
                    playerButton.className = 'btn';
                    playerButton.textContent = player.username;
                    playerButton.onclick = () => {
                        playerAction('compare', null, player.username);
                        closeCompareModal();
                    };
                    comparePlayerList.appendChild(playerButton);
                }
            });
            
            if (comparePlayerList.children.length === 0) {
                comparePlayerList.innerHTML = '<div class="message info">Ê≤°ÊúâÂèØÊØîÁâåÁöÑÁé©ÂÆ∂</div>';
            }
            
            document.getElementById('compare-modal').classList.remove('hidden');
        }

        // ÂÖ≥Èó≠ÊØîÁâåÊ®°ÊÄÅÊ°Ü
        function closeCompareModal() {
            document.getElementById('compare-modal').classList.add('hidden');
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(text, type) {
            const messageArea = document.getElementById('message-area');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(message);
            
            // 3ÁßíÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                message.remove();
            }, 3000);
        }
    </script>
</body>
</html>