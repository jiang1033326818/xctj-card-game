<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¸é‡‘èŠ± - XCTJå¡ç‰Œæ¸¸æˆ</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 50%, #FFD700 100%);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: linear-gradient(45deg, #FF6B6B, #EE5A24);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(238, 90, 36, 0.4);
        }

        .game-title {
            color: #FFD700;
            font-size: 1.8rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
        }

        .balance {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-area {
            flex: 3;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            color: white;
            backdrop-filter: blur(10px);
        }

        .players-area {
            flex: 1;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            color: white;
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.4rem;
            color: #FFD700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #FFD700;
        }

        .room-setup {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: rgba(255, 255, 255, 0.9);
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #0D47A1);
        }

        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #E65100);
        }

        .btn-warning:hover {
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #F44336, #B71C1C);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        .game-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-label {
            font-weight: bold;
        }

        .info-value {
            color: #FFD700;
        }

        .player-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .player-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name {
            font-weight: bold;
        }

        .player-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .status-waiting {
            background: #2196F3;
        }

        .status-playing {
            background: #4CAF50;
        }

        .status-folded {
            background: #FF9800;
        }

        .status-lost {
            background: #F44336;
        }

        .cards-area {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .card {
            width: 80px;
            height: 120px;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .card.red {
            color: #DC143C;
        }

        .card.black {
            color: #000;
        }

        .card-back {
            background: linear-gradient(135deg, #1e5799 0%, #207cca 50%, #2989d8 51%, #7db9e8 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .actions-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .pot-area {
            text-align: center;
            margin: 20px 0;
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFD700;
        }

        .current-player {
            background: rgba(255, 215, 0, 0.3) !important;
            border: 2px solid #FFD700;
        }

        .hidden {
            display: none;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.3);
            color: #fff;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.3);
            color: #fff;
        }

        .message.info {
            background: rgba(33, 150, 243, 0.3);
            color: #fff;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .card {
                width: 60px;
                height: 90px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="header-left">
                <button class="back-btn" onclick="goHome()">ğŸ”™ è¿”å›å¤§å…</button>
                <div class="game-title">ğŸƒ ç‚¸é‡‘èŠ±</div>
            </div>
            <div class="user-info">
                <div>
                    <span class="welcome">æ¬¢è¿ï¼Œ<span id="username">åŠ è½½ä¸­...</span></span>
                </div>
                <div>
                    <span class="balance">ä½™é¢: Â¥<span id="balance">0</span></span>
                </div>
                <div>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>

        <div id="loading" class="message info">
            æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...
        </div>

        <div id="main-content" class="main-content hidden">
            <!-- æ¸¸æˆåŒºåŸŸ -->
            <div class="game-area">
                <h2 class="section-title">æ¸¸æˆåŒºåŸŸ</h2>
                
                <!-- æˆ¿é—´è®¾ç½® -->
                <div id="room-setup" class="room-setup">
                    <h3>åˆ›å»ºæˆ¿é—´</h3>
                    <div class="form-group">
                        <label for="room-name">æˆ¿é—´åç§°</label>
                        <input type="text" id="room-name" placeholder="è¾“å…¥æˆ¿é—´åç§°">
                    </div>
                    <div class="form-group">
                        <label for="chip-amount">æºå¸¦ç­¹ç é‡</label>
                        <input type="number" id="chip-amount" placeholder="è¾“å…¥æºå¸¦ç­¹ç é‡" value="1000">
                    </div>
                    <div class="form-group">
                        <label for="max-bet">æœ€å¤§ä¸‹æ³¨é‡</label>
                        <input type="number" id="max-bet" placeholder="è¾“å…¥æœ€å¤§ä¸‹æ³¨é‡" value="500">
                    </div>
                    <div class="form-group">
                        <label for="max-meng-bet">æœ€å¤§ç„–ç‰Œä¸‹æ³¨é‡</label>
                        <input type="number" id="max-meng-bet" placeholder="è¾“å…¥æœ€å¤§ç„–ç‰Œä¸‹æ³¨é‡" value="100">
                    </div>
                    <div class="form-group">
                        <label for="base-bet">åº•æ³¨é‡</label>
                        <input type="number" id="base-bet" placeholder="è¾“å…¥åº•æ³¨é‡" value="10">
                    </div>
                    <button class="btn btn-primary" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
                </div>

                <!-- åŠ å…¥æˆ¿é—´ -->
                <div id="join-room" class="room-setup hidden">
                    <h3>åŠ å…¥æˆ¿é—´</h3>
                    <div class="form-group">
                        <label for="room-id">æˆ¿é—´ID</label>
                        <input type="text" id="room-id" placeholder="è¾“å…¥æˆ¿é—´ID">
                    </div>
                    <button class="btn btn-primary" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
                </div>

                <!-- æ¸¸æˆä¿¡æ¯ -->
                <div id="game-info" class="game-info hidden">
                    <div class="info-item">
                        <span class="info-label">æˆ¿é—´ID:</span>
                        <span class="info-value" id="room-id-display"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æˆ¿é—´åç§°:</span>
                        <span class="info-value" id="room-name-display"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å½“å‰è½®æ¬¡:</span>
                        <span class="info-value" id="current-round">1</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å½“å‰æ³¨é¢:</span>
                        <span class="info-value" id="current-bet">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å¥–æ± :</span>
                        <span class="info-value" id="pot">0</span>
                    </div>
                </div>

                <!-- åº•ç‰ŒåŒºåŸŸ -->
                <div id="cards-area" class="cards-area hidden">
                    <div class="card card-back">?</div>
                    <div class="card card-back">?</div>
                    <div class="card card-back">?</div>
                </div>

                <!-- å¥–æ±  -->
                <div id="pot-area" class="pot-area hidden">
                    å¥–æ± : Â¥<span id="pot-amount">0</span>
                </div>

                <!-- æ“ä½œåŒºåŸŸ -->
                <div id="actions-area" class="actions-area hidden">
                    <h3>æ‚¨çš„æ“ä½œ</h3>
                    <div class="action-buttons">
                        <button class="btn" onclick="playerAction('call')">è·Ÿæ³¨</button>
                        <button class="btn btn-primary" onclick="showRaiseModal()">åŠ æ³¨</button>
                        <button class="btn btn-warning" onclick="playerAction('meng')">ç„–ç‰Œ</button>
                        <button class="btn" onclick="showCompareModal()">æ¯”ç‰Œ</button>
                        <button class="btn btn-danger" onclick="playerAction('fold')">å¼ƒç‰Œ</button>
                    </div>
                </div>
            </div>

            <!-- ç©å®¶åŒºåŸŸ -->
            <div class="players-area">
                <h2 class="section-title">ç©å®¶åˆ—è¡¨</h2>
                <div id="player-list" class="player-list">
                    <div class="message info">ç­‰å¾…ç©å®¶åŠ å…¥...</div>
                </div>
                
                <div id="room-controls" class="hidden">
                    <button class="btn btn-primary" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
                </div>
            </div>
        </div>

        <!-- åŠ æ³¨æ¨¡æ€æ¡† -->
        <div id="raise-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>åŠ æ³¨</h3>
                    <span class="close-btn" onclick="closeRaiseModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="raise-amount">åŠ æ³¨é‡‘é¢</label>
                        <input type="number" id="raise-amount" placeholder="è¾“å…¥åŠ æ³¨é‡‘é¢">
                    </div>
                    <button class="btn btn-primary" onclick="confirmRaise()">ç¡®è®¤åŠ æ³¨</button>
                </div>
            </div>
        </div>

        <!-- æ¯”ç‰Œæ¨¡æ€æ¡† -->
        <div id="compare-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>é€‰æ‹©è¦æ¯”ç‰Œçš„ç©å®¶</h3>
                    <span class="close-btn" onclick="closeCompareModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="compare-player-list">
                        <!-- ç©å®¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message-area"></div>
    </div>

    <script>
        let currentUser = null;
        let currentRoom = null;
        let roomId = null;

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('load', async () => {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const response = await fetch('/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    
                    document.getElementById('username').textContent = user.username;
                    document.getElementById('balance').textContent = user.balance;
                    
                    // æ˜¾ç¤ºä¸»è¦å†…å®¹
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                } else {
                    // ç™»å½•å¤±æ•ˆï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        });

        // è¿”å›å¤§å…
        function goHome() {
            window.location.href = '/index.html';
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }

        // åˆ›å»ºæˆ¿é—´
        async function createRoom() {
            const roomName = document.getElementById('room-name').value;
            const chipAmount = parseInt(document.getElementById('chip-amount').value);
            const maxBet = parseInt(document.getElementById('max-bet').value);
            const maxMengBet = parseInt(document.getElementById('max-meng-bet').value);
            const baseBet = parseInt(document.getElementById('base-bet').value);

            if (!roomName || chipAmount <= 0 || maxBet <= 0 || maxMengBet <= 0 || baseBet <= 0) {
                showMessage('è¯·å¡«å†™å®Œæ•´çš„æˆ¿é—´ä¿¡æ¯', 'error');
                return;
            }

            if (maxMengBet > maxBet) {
                showMessage('æœ€å¤§ç„–ç‰Œä¸‹æ³¨é‡ä¸èƒ½è¶…è¿‡æœ€å¤§ä¸‹æ³¨é‡', 'error');
                return;
            }

            if (baseBet > chipAmount) {
                showMessage('åº•æ³¨é‡ä¸èƒ½è¶…è¿‡æºå¸¦ç­¹ç é‡', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/zhajinhua/create-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roomName,
                        chipAmount,
                        maxBet,
                        maxMengBet,
                        baseBet
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    roomId = result.room_id;
                    showMessage('æˆ¿é—´åˆ›å»ºæˆåŠŸ', 'success');
                    document.getElementById('room-setup').classList.add('hidden');
                    document.getElementById('join-room').classList.add('hidden');
                    document.getElementById('game-info').classList.remove('hidden');
                    document.getElementById('room-id-display').textContent = roomId;
                    document.getElementById('room-name-display').textContent = roomName;
                    
                    // å¼€å§‹è½®è¯¢æˆ¿é—´ä¿¡æ¯
                    pollRoomInfo();
                } else {
                    showMessage(result.error || 'åˆ›å»ºæˆ¿é—´å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ›å»ºæˆ¿é—´é”™è¯¯:', error);
                showMessage('åˆ›å»ºæˆ¿é—´å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // åŠ å…¥æˆ¿é—´
        async function joinRoom() {
            const roomIdInput = document.getElementById('room-id').value;
            
            if (!roomIdInput) {
                showMessage('è¯·è¾“å…¥æˆ¿é—´ID', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/zhajinhua/join-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roomId: roomIdInput
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    roomId = roomIdInput;
                    showMessage('åŠ å…¥æˆ¿é—´æˆåŠŸ', 'success');
                    document.getElementById('room-setup').classList.add('hidden');
                    document.getElementById('join-room').classList.add('hidden');
                    document.getElementById('game-info').classList.remove('hidden');
                    document.getElementById('room-id-display').textContent = roomId;
                    
                    // å¼€å§‹è½®è¯¢æˆ¿é—´ä¿¡æ¯
                    pollRoomInfo();
                } else {
                    showMessage(result.error || 'åŠ å…¥æˆ¿é—´å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ å…¥æˆ¿é—´é”™è¯¯:', error);
                showMessage('åŠ å…¥æˆ¿é—´å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // è½®è¯¢æˆ¿é—´ä¿¡æ¯
        function pollRoomInfo() {
            if (roomId) {
                getRoomInfo();
                setTimeout(pollRoomInfo, 3000); // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
            }
        }

        // è·å–æˆ¿é—´ä¿¡æ¯
        async function getRoomInfo() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/zhajinhua/room-info?roomId=${roomId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    currentRoom = result.room;
                    updateRoomDisplay();
                } else {
                    showMessage(result.error || 'è·å–æˆ¿é—´ä¿¡æ¯å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è·å–æˆ¿é—´ä¿¡æ¯é”™è¯¯:', error);
            }
        }

        // æ›´æ–°æˆ¿é—´æ˜¾ç¤º
        function updateRoomDisplay() {
            if (!currentRoom) return;

            // æ›´æ–°æˆ¿é—´ä¿¡æ¯
            document.getElementById('room-name-display').textContent = currentRoom.room_name;
            document.getElementById('current-round').textContent = currentRoom.current_round;
            document.getElementById('current-bet').textContent = currentRoom.current_bet;
            document.getElementById('pot').textContent = currentRoom.pot;
            document.getElementById('pot-amount').textContent = currentRoom.pot;

            // æ›´æ–°ç©å®¶åˆ—è¡¨
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            
            if (currentRoom.players.length === 0) {
                playerList.innerHTML = '<div class="message info">ç­‰å¾…ç©å®¶åŠ å…¥...</div>';
            } else {
                currentRoom.players.forEach(player => {
                    const playerItem = document.createElement('div');
                    playerItem.className = `player-item ${player.username === currentUser.username ? 'current-player' : ''}`;
                    
                    let statusClass = 'status-waiting';
                    let statusText = 'ç­‰å¾…ä¸­';
                    
                    if (player.status === 'playing') {
                        statusClass = 'status-playing';
                        statusText = 'æ¸¸æˆä¸­';
                    } else if (player.status === 'folded') {
                        statusClass = 'status-folded';
                        statusText = 'å·²å¼ƒç‰Œ';
                    } else if (player.status === 'lost') {
                        statusClass = 'status-lost';
                        statusText = 'å·²è¾“';
                    }
                    
                    playerItem.innerHTML = `
                        <div>
                            <div class="player-name">${player.username} ${player.is_creator ? '(æˆ¿ä¸»)' : ''}</div>
                            <div>ç­¹ç : Â¥${player.chips}</div>
                        </div>
                        <div class="player-status ${statusClass}">${statusText}</div>
                    `;
                    
                    playerList.appendChild(playerItem);
                });
            }

            // æ˜¾ç¤ºæˆ¿ä¸»æ§åˆ¶æŒ‰é’®
            const roomControls = document.getElementById('room-controls');
            const isCreator = currentRoom.creator === currentUser.username;
            const isWaiting = currentRoom.game_status === 'waiting';
            
            if (isCreator && isWaiting) {
                roomControls.classList.remove('hidden');
            } else {
                roomControls.classList.add('hidden');
            }

            // æ˜¾ç¤ºæ¸¸æˆç›¸å…³å…ƒç´ 
            if (currentRoom.game_status === 'playing') {
                document.getElementById('cards-area').classList.remove('hidden');
                document.getElementById('pot-area').classList.remove('hidden');
                
                // å¦‚æœæ˜¯å½“å‰ç©å®¶çš„å›åˆï¼Œæ˜¾ç¤ºæ“ä½œæŒ‰é’®
                const currentPlayerIndex = currentRoom.current_player_index;
                const currentPlayer = currentRoom.players[currentPlayerIndex];
                
                if (currentPlayer && currentPlayer.username === currentUser.username) {
                    document.getElementById('actions-area').classList.remove('hidden');
                } else {
                    document.getElementById('actions-area').classList.add('hidden');
                }
            } else {
                document.getElementById('cards-area').classList.add('hidden');
                document.getElementById('pot-area').classList.add('hidden');
                document.getElementById('actions-area').classList.add('hidden');
            }

            // æ¸¸æˆç»“æŸå¤„ç†
            if (currentRoom.game_status === 'finished') {
                showMessage(`${currentRoom.winner} è·å¾—äº†æ¸¸æˆèƒœåˆ©ï¼Œèµ¢å¾— Â¥${currentRoom.pot}!`, 'success');
            }
        }

        // å¼€å§‹æ¸¸æˆ
        async function startGame() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/zhajinhua/start-game', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roomId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('æ¸¸æˆå¼€å§‹', 'success');
                    currentRoom = result.room;
                    updateRoomDisplay();
                } else {
                    showMessage(result.error || 'å¼€å§‹æ¸¸æˆå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('å¼€å§‹æ¸¸æˆé”™è¯¯:', error);
                showMessage('å¼€å§‹æ¸¸æˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // ç©å®¶æ“ä½œ
        async function playerAction(action, betAmount = null, targetPlayer = null) {
            try {
                const token = localStorage.getItem('token');
                const requestBody = {
                    roomId,
                    action
                };
                
                if (betAmount !== null) {
                    requestBody.betAmount = betAmount;
                }
                
                if (targetPlayer !== null) {
                    requestBody.targetPlayer = targetPlayer;
                }
                
                const response = await fetch('/api/zhajinhua/player-action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    if (result.room) {
                        currentRoom = result.room;
                        updateRoomDisplay();
                    }
                } else {
                    showMessage(result.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç©å®¶æ“ä½œé”™è¯¯:', error);
                showMessage('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // æ˜¾ç¤ºåŠ æ³¨æ¨¡æ€æ¡†
        function showRaiseModal() {
            document.getElementById('raise-modal').classList.remove('hidden');
        }

        // å…³é—­åŠ æ³¨æ¨¡æ€æ¡†
        function closeRaiseModal() {
            document.getElementById('raise-modal').classList.add('hidden');
        }

        // ç¡®è®¤åŠ æ³¨
        function confirmRaise() {
            const raiseAmount = parseInt(document.getElementById('raise-amount').value);
            
            if (isNaN(raiseAmount) || raiseAmount <= 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„åŠ æ³¨é‡‘é¢', 'error');
                return;
            }
            
            playerAction('raise', raiseAmount);
            closeRaiseModal();
            document.getElementById('raise-amount').value = '';
        }

        // æ˜¾ç¤ºæ¯”ç‰Œæ¨¡æ€æ¡†
        function showCompareModal() {
            if (!currentRoom || currentRoom.players.length < 2) {
                showMessage('æ²¡æœ‰è¶³å¤Ÿçš„ç©å®¶è¿›è¡Œæ¯”ç‰Œ', 'error');
                return;
            }
            
            const comparePlayerList = document.getElementById('compare-player-list');
            comparePlayerList.innerHTML = '';
            
            currentRoom.players.forEach(player => {
                // æ’é™¤è‡ªå·±å’Œå·²å¼ƒç‰Œ/å·²è¾“çš„ç©å®¶
                if (player.username !== currentUser.username && 
                    player.status === 'playing') {
                    const playerButton = document.createElement('button');
                    playerButton.className = 'btn';
                    playerButton.textContent = player.username;
                    playerButton.onclick = () => {
                        playerAction('compare', null, player.username);
                        closeCompareModal();
                    };
                    comparePlayerList.appendChild(playerButton);
                }
            });
            
            if (comparePlayerList.children.length === 0) {
                comparePlayerList.innerHTML = '<div class="message info">æ²¡æœ‰å¯æ¯”ç‰Œçš„ç©å®¶</div>';
            }
            
            document.getElementById('compare-modal').classList.remove('hidden');
        }

        // å…³é—­æ¯”ç‰Œæ¨¡æ€æ¡†
        function closeCompareModal() {
            document.getElementById('compare-modal').classList.add('hidden');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageArea = document.getElementById('message-area');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(message);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                message.remove();
            }, 3000);
        }
    </script>
</body>
</html>