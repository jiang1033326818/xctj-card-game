<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB设置助手</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h1, h2 {
            color: #333;
        }
        pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .step {
            margin-bottom: 15px;
            padding-left: 20px;
            border-left: 3px solid #007bff;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .tabs {
            display: flex;
            margin-bottom: 10px;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
        }
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 0 5px 5px 5px;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>MongoDB Atlas设置助手</h1>
    
    <div class="section">
        <h2>1. 检查当前环境变量</h2>
        <button id="checkEnv">检查环境变量</button>
        <pre id="envResult">点击按钮检查...</pre>
    </div>
    
    <div class="section">
        <h2>2. MongoDB Atlas设置步骤</h2>
        
        <div class="step">
            <h3>步骤1: 登录MongoDB Atlas</h3>
            <p>访问 <a href="https://cloud.mongodb.com" target="_blank">https://cloud.mongodb.com</a> 并登录您的账户。</p>
        </div>
        
        <div class="step">
            <h3>步骤2: 检查网络访问</h3>
            <p>在左侧菜单中点击"Network Access"，确保有一个条目允许从任何地方访问（0.0.0.0/0）。</p>
            <p>如果没有，点击"Add IP Address"，然后选择"Allow Access from Anywhere"。</p>
        </div>
        
        <div class="step">
            <h3>步骤3: 检查数据库用户</h3>
            <p>在左侧菜单中点击"Database Access"，确认您有一个用户名为"1033326818"的用户。</p>
        </div>
        
        <div class="step">
            <h3>步骤4: 重置密码</h3>
            <p>如果您不记得密码，点击用户旁边的"Edit"按钮，然后选择"Edit Password"，设置一个新密码。</p>
        </div>
        
        <div class="step">
            <h3>步骤5: 获取连接字符串</h3>
            <p>返回到集群页面，点击"Connect"按钮，选择"Connect your application"，然后复制连接字符串。</p>
            <p>将连接字符串中的&lt;password&gt;替换为您的实际密码。</p>
        </div>
    </div>
    
    <div class="section">
        <h2>3. 测试连接字符串</h2>
        <p>在下面输入您的MongoDB连接字符串进行测试：</p>
        <input type="text" id="mongoUri" placeholder="mongodb+srv://username:password@cluster.mongodb.net/?retryWrites=true&w=majority">
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('tab1')">标准测试</div>
            <div class="tab" onclick="showTab('tab2')">替代测试</div>
            <div class="tab" onclick="showTab('tab3')">简化连接字符串</div>
        </div>
        
        <div id="tab1" class="tab-content active">
            <button id="testUri">测试连接</button>
            <p>使用标准MongoDB驱动和SSL选项测试连接。</p>
        </div>
        
        <div id="tab2" class="tab-content">
            <button id="testUriAlt">替代测试</button>
            <p>使用替代连接选项测试连接（不使用SSL选项）。</p>
        </div>
        
        <div id="tab3" class="tab-content">
            <button id="testUriSimple">测试简化连接字符串</button>
            <p>尝试移除连接字符串中的额外参数，只保留基本部分。</p>
        </div>
        
        <pre id="testResult">等待测试...</pre>
    </div>
    
    <div class="section">
        <h2>4. 更新Vercel环境变量</h2>
        <div class="step">
            <h3>步骤1: 登录Vercel</h3>
            <p>访问 <a href="https://vercel.com" target="_blank">https://vercel.com</a> 并登录您的账户。</p>
        </div>
        
        <div class="step">
            <h3>步骤2: 选择项目</h3>
            <p>找到并选择您的"xctj-card-game"项目。</p>
        </div>
        
        <div class="step">
            <h3>步骤3: 更新环境变量</h3>
            <p>点击"Settings" → "Environment Variables"，找到MONGODB_URI变量并更新为您测试成功的连接字符串。</p>
        </div>
        
        <div class="step">
            <h3>步骤4: 重新部署</h3>
            <p>保存环境变量后，点击"Deployments"，然后点击"Redeploy"按钮重新部署您的应用。</p>
        </div>
    </div>
    
    <div class="section">
        <h2>5. 替代解决方案</h2>
        <p>如果MongoDB Atlas连接仍然有问题，您可以考虑以下替代方案：</p>
        
        <div class="step">
            <h3>选项1: 使用Vercel KV存储</h3>
            <p>Vercel提供了内置的KV存储解决方案，它与Vercel无服务器函数完美集成。</p>
            <p><a href="https://vercel.com/docs/storage/vercel-kv" target="_blank">了解更多关于Vercel KV</a></p>
        </div>
        
        <div class="step">
            <h3>选项2: 使用Vercel Postgres</h3>
            <p>Vercel还提供了托管的PostgreSQL数据库服务。</p>
            <p><a href="https://vercel.com/docs/storage/vercel-postgres" target="_blank">了解更多关于Vercel Postgres</a></p>
        </div>
        
        <div class="step">
            <h3>选项3: 使用其他云数据库服务</h3>
            <p>您也可以尝试其他云数据库服务，如Supabase、Firebase或PlanetScale。</p>
        </div>
    </div>
    
    <script>
        function showTab(tabId) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 取消所有标签的活动状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选定的标签内容
            document.getElementById(tabId).classList.add('active');
            
            // 设置选定标签为活动状态
            Array.from(document.querySelectorAll('.tab')).find(tab => 
                tab.getAttribute('onclick').includes(tabId)
            ).classList.add('active');
        }
        
        document.getElementById('checkEnv').addEventListener('click', async () => {
            const resultElement = document.getElementById('envResult');
            resultElement.textContent = '正在检查环境变量...';
            
            try {
                const response = await fetch('/api/check-env');
                const data = await response.json();
                resultElement.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                resultElement.textContent = `错误: ${error.message}`;
            }
        });
        
        document.getElementById('testUri').addEventListener('click', async () => {
            const uri = document.getElementById('mongoUri').value.trim();
            const resultElement = document.getElementById('testResult');
            
            if (!uri) {
                resultElement.textContent = '请输入MongoDB连接字符串';
                resultElement.className = 'error';
                return;
            }
            
            resultElement.textContent = '正在测试连接...';
            resultElement.className = '';
            
            try {
                const response = await fetch('/api/test-db', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ uri })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultElement.textContent = '连接成功! 您可以使用此连接字符串更新Vercel环境变量。';
                    resultElement.className = 'success';
                } else {
                    resultElement.textContent = `连接失败: ${data.message}`;
                    resultElement.className = 'error';
                }
            } catch (error) {
                resultElement.textContent = `错误: ${error.message}`;
                resultElement.className = 'error';
            }
        });
        
        document.getElementById('testUriAlt').addEventListener('click', async () => {
            const uri = document.getElementById('mongoUri').value.trim();
            const resultElement = document.getElementById('testResult');
            
            if (!uri) {
                resultElement.textContent = '请输入MongoDB连接字符串';
                resultElement.className = 'error';
                return;
            }
            
            resultElement.textContent = '正在使用替代选项测试连接...';
            resultElement.className = '';
            
            try {
                const response = await fetch('/api/test-db-alt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ uri })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultElement.textContent = '连接成功! 您可以使用此连接字符串更新Vercel环境变量。';
                    resultElement.className = 'success';
                } else {
                    resultElement.textContent = `连接失败: ${data.message}`;
                    resultElement.className = 'error';
                }
            } catch (error) {
                resultElement.textContent = `错误: ${error.message}`;
                resultElement.className = 'error';
            }
        });
        
        document.getElementById('testUriSimple').addEventListener('click', async () => {
            const uri = document.getElementById('mongoUri').value.trim();
            const resultElement = document.getElementById('testResult');
            
            if (!uri) {
                resultElement.textContent = '请输入MongoDB连接字符串';
                resultElement.className = 'error';
                return;
            }
            
            // 简化连接字符串，移除查询参数
            let simplifiedUri = uri;
            const questionMarkIndex = uri.indexOf('?');
            if (questionMarkIndex !== -1) {
                simplifiedUri = uri.substring(0, questionMarkIndex);
            }
            
            resultElement.textContent = `正在测试简化连接字符串: ${simplifiedUri}`;
            resultElement.className = '';
            
            try {
                const response = await fetch('/api/test-db-alt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ uri: simplifiedUri })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultElement.textContent = `连接成功! 您可以使用此简化连接字符串更新Vercel环境变量: ${simplifiedUri}`;
                    resultElement.className = 'success';
                } else {
                    resultElement.textContent = `连接失败: ${data.message}`;
                    resultElement.className = 'error';
                }
            } catch (error) {
                resultElement.textContent = `错误: ${error.message}`;
                resultElement.className = 'error';
            }
        });
    </script>
</body>
</html>