<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å‘˜æ§åˆ¶å° - å¡ç‰Œæ¸¸æˆ</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    h1 {
      margin: 0;
      color: #2196F3;
    }
    .user-info {
      display: flex;
      align-items: center;
    }
    .admin-badge {
      background-color: #ff9800;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      margin-right: 20px;
      font-weight: bold;
    }
    .logout-btn {
      padding: 8px 16px;
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .panel {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    .panel h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .stat-card {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #2196F3;
    }
    .stat-label {
      color: #666;
      font-size: 14px;
    }
    .chart-container {
      height: 300px;
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    .win-record {
      color: #2e7d32;
    }
    .lose-record {
      color: #c62828;
    }
    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #2196F3;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-right: 10px;
    }
    .tab.active {
      border-bottom-color: #2196F3;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .btn {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .btn:hover {
      background-color: #45a049;
    }
    .btn-secondary {
      background-color: #2196F3;
    }
    .btn-secondary:hover {
      background-color: #0b7dda;
    }
    .alert {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
    .alert-success {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }
    .alert-danger {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ç®¡ç†å‘˜æ§åˆ¶å°</h1>
      <div class="user-info">
        <div class="admin-badge">ç®¡ç†å‘˜</div>
        <button id="logout-btn" class="logout-btn">é€€å‡ºç™»å½•</button>
      </div>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="dashboard">ä»ªè¡¨ç›˜</div>
      <div class="tab" data-tab="users">ç”¨æˆ·ç®¡ç†</div>
      <div class="tab" data-tab="history">æ¸¸æˆè®°å½•</div>
    </div>

    <!-- ä»ªè¡¨ç›˜ -->
    <div id="dashboard" class="tab-content active">
      <div class="panel">
        <h2>æ¸¸æˆç»Ÿè®¡</h2>
        <div id="stats-loading" class="loading">
          <div class="spinner"></div>
          <p>åŠ è½½ä¸­...</p>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">æ€»æ¸¸æˆæ¬¡æ•°</div>
            <div id="total-games" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">æ€»ä¸‹æ³¨é‡‘é¢</div>
            <div id="total-bets" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">æ€»æ´¾å½©é‡‘é¢</div>
            <div id="total-payouts" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">åº„å®¶ç›ˆåˆ©</div>
            <div id="house-profit" class="stat-value">0</div>
          </div>
        </div>

        <h3>èŠ±è‰²åˆ†å¸ƒ</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">çº¢æ¡ƒ â™¥</div>
            <div id="hearts-count" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">æ–¹å— â™¦</div>
            <div id="diamonds-count" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">æ¢…èŠ± â™£</div>
            <div id="clubs-count" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">é»‘æ¡ƒ â™ </div>
            <div id="spades-count" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">å°ä¸‘ ğŸƒ</div>
            <div id="joker-count" class="stat-value">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·ç®¡ç† -->
    <div id="users" class="tab-content">
      <div class="panel">
        <h2>ç”¨æˆ·åˆ—è¡¨</h2>
        <div id="users-loading" class="loading">
          <div class="spinner"></div>
          <p>åŠ è½½ä¸­...</p>
        </div>
        <table id="users-table">
          <thead>
            <tr>
              <th>ç”¨æˆ·å</th>
              <th>ä½™é¢</th>
              <th>è§’è‰²</th>
              <th>åˆ›å»ºæ—¶é—´</th>
            </tr>
          </thead>
          <tbody id="users-body">
            <!-- ç”¨æˆ·åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
          </tbody>
        </table>
      </div>

      <div class="panel">
        <h2>åˆ›å»ºæ–°ç”¨æˆ·</h2>
        <div id="create-alert" class="alert"></div>
        <form id="create-user-form">
          <div class="form-group">
            <label for="username">ç”¨æˆ·å</label>
            <input type="text" id="username" required>
          </div>
          <div class="form-group">
            <label for="password">å¯†ç </label>
            <input type="password" id="password" required>
          </div>
          <div class="form-group">
            <label for="balance">åˆå§‹ä½™é¢</label>
            <input type="number" id="balance" value="1000" min="0" required>
          </div>
          <button type="submit" class="btn">åˆ›å»ºç”¨æˆ·</button>
        </form>
      </div>
    </div>

    <!-- æ¸¸æˆè®°å½• -->
    <div id="history" class="tab-content">
      <div class="panel">
        <h2>æ¸¸æˆå†å²è®°å½•</h2>
        <div id="history-loading" class="loading">
          <div class="spinner"></div>
          <p>åŠ è½½ä¸­...</p>
        </div>
        <table id="history-table">
          <thead>
            <tr>
              <th>æ—¶é—´</th>
              <th>ç”¨æˆ·</th>
              <th>ä¸‹æ³¨èŠ±è‰²</th>
              <th>ç»“æœèŠ±è‰²</th>
              <th>ä¸‹æ³¨é‡‘é¢</th>
              <th>è¾“èµ¢</th>
            </tr>
          </thead>
          <tbody id="history-body">
            <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // å…ƒç´ å¼•ç”¨
      const logoutBtn = document.getElementById('logout-btn');
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      // ç»Ÿè®¡æ•°æ®å…ƒç´ 
      const totalGamesEl = document.getElementById('total-games');
      const totalBetsEl = document.getElementById('total-bets');
      const totalPayoutsEl = document.getElementById('total-payouts');
      const houseProfitEl = document.getElementById('house-profit');
      const heartsCountEl = document.getElementById('hearts-count');
      const diamondsCountEl = document.getElementById('diamonds-count');
      const clubsCountEl = document.getElementById('clubs-count');
      const spadesCountEl = document.getElementById('spades-count');
      const jokerCountEl = document.getElementById('joker-count');
      
      // åŠ è½½å…ƒç´ 
      const statsLoadingEl = document.getElementById('stats-loading');
      const usersLoadingEl = document.getElementById('users-loading');
      const historyLoadingEl = document.getElementById('history-loading');
      
      // è¡¨æ ¼å…ƒç´ 
      const usersBodyEl = document.getElementById('users-body');
      const historyBodyEl = document.getElementById('history-body');
      
      // è¡¨å•å…ƒç´ 
      const createUserForm = document.getElementById('create-user-form');
      const createAlertEl = document.getElementById('create-alert');

      // åˆå§‹åŒ–
      checkAuth();
      loadStats();

      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ä¸”æ˜¯ç®¡ç†å‘˜
      async function checkAuth() {
        try {
          const response = await fetch('/api/user');
          if (!response.ok) {
            // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
            window.location.href = '/login.html';
            return;
          }

          const data = await response.json();
          if (!data.user.isAdmin) {
            // éç®¡ç†å‘˜ç”¨æˆ·ï¼Œé‡å®šå‘åˆ°æ¸¸æˆé¡µé¢
            window.location.href = '/game.html';
            return;
          }
        } catch (error) {
          console.error('æ£€æŸ¥è®¤è¯å¤±è´¥:', error);
          window.location.href = '/login.html';
        }
      }

      // åŠ è½½ç»Ÿè®¡æ•°æ®
      async function loadStats() {
        try {
          statsLoadingEl.style.display = 'block';
          const response = await fetch('/api/stats');
          
          if (!response.ok) {
            throw new Error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥');
          }

          const data = await response.json();
          
          // æ›´æ–°ç»Ÿè®¡æ•°æ®
          totalGamesEl.textContent = data.totalGames;
          totalBetsEl.textContent = data.totalBets;
          totalPayoutsEl.textContent = data.totalPayouts;
          houseProfitEl.textContent = data.houseProfit;
          heartsCountEl.textContent = data.heartsCount;
          diamondsCountEl.textContent = data.diamondsCount;
          clubsCountEl.textContent = data.clubsCount;
          spadesCountEl.textContent = data.spadesCount;
          jokerCountEl.textContent = data.jokerCount;
        } catch (error) {
          console.error('åŠ è½½ç»Ÿè®¡æ•°æ®é”™è¯¯:', error);
        } finally {
          statsLoadingEl.style.display = 'none';
        }
      }

      // åŠ è½½ç”¨æˆ·åˆ—è¡¨
      async function loadUsers() {
        try {
          usersLoadingEl.style.display = 'block';
          const response = await fetch('/api/users');
          
          if (!response.ok) {
            throw new Error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
          }

          const data = await response.json();
          renderUsers(data.users);
        } catch (error) {
          console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨é”™è¯¯:', error);
        } finally {
          usersLoadingEl.style.display = 'none';
        }
      }

      // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
      function renderUsers(users) {
        usersBodyEl.innerHTML = '';
        
        if (users.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="4" style="text-align: center;">æš‚æ— ç”¨æˆ·</td>';
          usersBodyEl.appendChild(row);
          return;
        }

        users.forEach(user => {
          const row = document.createElement('tr');
          
          // æ ¼å¼åŒ–æ—¶é—´
          const date = new Date(user.created_at);
          const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
          
          row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.balance}</td>
            <td>${user.is_admin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</td>
            <td>${formattedDate}</td>
          `;
          
          usersBodyEl.appendChild(row);
        });
      }

      // åŠ è½½æ¸¸æˆå†å²
      async function loadHistory() {
        try {
          historyLoadingEl.style.display = 'block';
          const response = await fetch('/api/history');
          
          if (!response.ok) {
            throw new Error('åŠ è½½å†å²è®°å½•å¤±è´¥');
          }

          const data = await response.json();
          renderHistory(data.records);
        } catch (error) {
          console.error('åŠ è½½å†å²è®°å½•é”™è¯¯:', error);
        } finally {
          historyLoadingEl.style.display = 'none';
        }
      }

      // æ¸²æŸ“å†å²è®°å½•
      function renderHistory(records) {
        historyBodyEl.innerHTML = '';
        
        if (records.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="6" style="text-align: center;">æš‚æ— æ¸¸æˆè®°å½•</td>';
          historyBodyEl.appendChild(row);
          return;
        }

        records.forEach(record => {
          const row = document.createElement('tr');
          
          // æ ¼å¼åŒ–æ—¶é—´
          const date = new Date(record.created_at);
          const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
          
          // èŠ±è‰²ç¬¦å·
          const suitSymbols = {
            hearts: 'â™¥',
            diamonds: 'â™¦',
            clubs: 'â™£',
            spades: 'â™ ',
            joker: 'ğŸƒ'
          };
          
          // èŠ±è‰²ä¸­æ–‡åç§°
          const suitNames = {
            hearts: 'çº¢æ¡ƒ',
            diamonds: 'æ–¹å—',
            clubs: 'æ¢…èŠ±',
            spades: 'é»‘æ¡ƒ',
            joker: 'å°ä¸‘'
          };
          
          // èŠ±è‰²é¢œè‰²
          const suitColors = {
            hearts: 'red',
            diamonds: 'red',
            clubs: 'black',
            spades: 'black',
            joker: 'purple'
          };
          
          row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${record.username}</td>
            <td><span style="color: ${suitColors[record.bet_suit]}">${suitSymbols[record.bet_suit]}</span> ${suitNames[record.bet_suit]}</td>
            <td><span style="color: ${suitColors[record.result_suit]}">${suitSymbols[record.result_suit]}</span> ${suitNames[record.result_suit]}</td>
            <td>${record.amount}</td>
            <td class="${record.win ? 'win-record' : 'lose-record'}">${record.win ? 'èµ¢ +' + record.win_amount : 'è¾“'}</td>
          `;
          
          historyBodyEl.appendChild(row);
        });
      }

      // åˆ›å»ºç”¨æˆ·
      async function createUser(username, password, balance) {
        try {
          const response = await fetch('/api/create-user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password, balance })
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'åˆ›å»ºç”¨æˆ·å¤±è´¥');
          }
          
          showAlert('åˆ›å»ºç”¨æˆ·æˆåŠŸ', 'success');
          createUserForm.reset();
          loadUsers();
        } catch (error) {
          console.error('åˆ›å»ºç”¨æˆ·é”™è¯¯:', error);
          showAlert(error.message, 'danger');
        }
      }

      // æ˜¾ç¤ºæç¤ºä¿¡æ¯
      function showAlert(message, type) {
        createAlertEl.textContent = message;
        createAlertEl.className = `alert alert-${type}`;
        createAlertEl.style.display = 'block';
        
        // 5ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
          createAlertEl.style.display = 'none';
        }, 5000);
      }

      // æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // è®¾ç½®å½“å‰æ ‡ç­¾ä¸ºæ´»åŠ¨çŠ¶æ€
          this.classList.add('active');
          const tabId = this.dataset.tab;
          document.getElementById(tabId).classList.add('active');
          
          // åŠ è½½å¯¹åº”æ ‡ç­¾çš„æ•°æ®
          if (tabId === 'dashboard') {
            loadStats();
          } else if (tabId === 'users') {
            loadUsers();
          } else if (tabId === 'history') {
            loadHistory();
          }
        });
      });

      // åˆ›å»ºç”¨æˆ·è¡¨å•æäº¤äº‹ä»¶
      createUserForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const balance = parseInt(document.getElementById('balance').value);
        
        if (!username || !password) {
          showAlert('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ', 'danger');
          return;
        }
        
        if (password.length < 6) {
          showAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½', 'danger');
          return;
        }
        
        if (isNaN(balance) || balance < 0) {
          showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆå§‹ä½™é¢', 'danger');
          return;
        }
        
        createUser(username, password, balance);
      });

      // é€€å‡ºç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      logoutBtn.addEventListener('click', async function() {
        try {
          await fetch('/api/logout');
          window.location.href = '/login.html';
        } catch (error) {
          console.error('ç™»å‡ºé”™è¯¯:', error);
        }
      });
    });
  </script>
</body>
</html>