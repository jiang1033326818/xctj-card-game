<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å‘˜é¢æ¿ - å–œä»å¤©é™</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background-color: #2196F3;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    h1 {
      margin: 0;
      font-size: 24px;
    }
    .user-info {
      display: flex;
      align-items: center;
    }
    .user-info span {
      margin-right: 15px;
    }
    .btn {
      padding: 8px 16px;
      background-color: #1976D2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #0D47A1;
    }
    .card {
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h2 {
      margin-top: 0;
      color: #2196F3;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    .stat-card {
      background-color: #f9f9f9;
      border-radius: 5px;
      padding: 15px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #2196F3;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    .win {
      color: #4CAF50;
    }
    .lose {
      color: #F44336;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .error-message {
      color: #F44336;
      padding: 10px;
      background-color: #FFEBEE;
      border-radius: 4px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ® å–œä»å¤©é™ - ç®¡ç†å‘˜é¢æ¿</h1>
      <div class="user-info">
        <span id="username">åŠ è½½ä¸­...</span>
        <span id="balance">ä½™é¢: åŠ è½½ä¸­...</span>
        <button class="btn" onclick="logout()">ç™»å‡º</button>
      </div>
    </header>
    
    <div class="card">
      <h2>ç³»ç»Ÿç»Ÿè®¡</h2>
      <div id="stats-loading" class="loading">åŠ è½½ç»Ÿè®¡æ•°æ®ä¸­...</div>
      <div id="stats-error" class="error-message" style="display: none;"></div>
      <div id="stats-container" class="stats-grid" style="display: none;">
        <div class="stat-card">
          <div class="stat-label">æ€»æ¸¸æˆæ¬¡æ•°</div>
          <div id="total-games" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ€»ä¸‹æ³¨é‡‘é¢</div>
          <div id="total-bets" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ€»æ´¾å½©é‡‘é¢</div>
          <div id="total-payouts" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">åº„å®¶ç›ˆåˆ©</div>
          <div id="house-profit" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">çº¢æ¡ƒæ¬¡æ•°</div>
          <div id="hearts-count" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ–¹å—æ¬¡æ•°</div>
          <div id="diamonds-count" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ¢…èŠ±æ¬¡æ•°</div>
          <div id="clubs-count" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">é»‘æ¡ƒæ¬¡æ•°</div>
          <div id="spades-count" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å°ä¸‘æ¬¡æ•°</div>
          <div id="joker-count" class="stat-value">0</div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h2>ç”¨æˆ·åˆ—è¡¨</h2>
      <div id="users-loading" class="loading">åŠ è½½ç”¨æˆ·æ•°æ®ä¸­...</div>
      <div id="users-error" class="error-message" style="display: none;"></div>
      <div id="users-container" style="display: none;">
        <table id="users-table">
          <thead>
            <tr>
              <th>ç”¨æˆ·å</th>
              <th>ä½™é¢</th>
              <th>è§’è‰²</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æœ€åç™»å½•</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <!-- ç”¨æˆ·æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="card">
      <h2>æ¸¸æˆè®°å½•</h2>
      <div id="records-loading" class="loading">åŠ è½½æ¸¸æˆè®°å½•ä¸­...</div>
      <div id="records-error" class="error-message" style="display: none;"></div>
      <div id="records-container" style="display: none;">
        <table id="records-table">
          <thead>
            <tr>
              <th>ç”¨æˆ·</th>
              <th>ä¸‹æ³¨èŠ±è‰²</th>
              <th>ç»“æœèŠ±è‰²</th>
              <th>ä¸‹æ³¨é‡‘é¢</th>
              <th>è¾“èµ¢</th>
              <th>èµ¢å–é‡‘é¢</th>
              <th>æ—¶é—´</th>
            </tr>
          </thead>
          <tbody id="records-tbody">
            <!-- æ¸¸æˆè®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åŠ è½½æ•°æ®
    window.addEventListener('load', async () => {
      try {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const userResponse = await fetch('/api/user');
        if (!userResponse.ok) {
          // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
          window.location.href = '/login.html';
          return;
        }
        
        const userData = await userResponse.json();
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
        if (!userData.is_admin) {
          // ä¸æ˜¯ç®¡ç†å‘˜ï¼Œé‡å®šå‘åˆ°æ¸¸æˆé¡µé¢
          window.location.href = '/game.html';
          return;
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        document.getElementById('username').textContent = userData.username;
        document.getElementById('balance').textContent = `ä½™é¢: ${userData.balance}`;
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        loadStats();
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        loadUsers();
        
        // åŠ è½½æ¸¸æˆè®°å½•
        loadGameRecords();
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    });

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const response = await fetch('/api/house_stats');
        
        if (!response.ok) {
          throw new Error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');
        }
        
        const data = await response.json();
        
        if (!data.success || !data.stats) {
          throw new Error('ç»Ÿè®¡æ•°æ®æ ¼å¼é”™è¯¯');
        }
        
        // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
        document.getElementById('total-games').textContent = data.stats.totalGames;
        document.getElementById('total-bets').textContent = data.stats.totalBets;
        document.getElementById('total-payouts').textContent = data.stats.totalPayouts;
        document.getElementById('house-profit').textContent = data.stats.houseProfit;
        document.getElementById('hearts-count').textContent = data.stats.heartsCount;
        document.getElementById('diamonds-count').textContent = data.stats.diamondsCount;
        document.getElementById('clubs-count').textContent = data.stats.clubsCount;
        document.getElementById('spades-count').textContent = data.stats.spadesCount;
        document.getElementById('joker-count').textContent = data.stats.jokerCount;
        
        // éšè—åŠ è½½æç¤ºï¼Œæ˜¾ç¤ºç»Ÿè®¡æ•°æ®
        document.getElementById('stats-loading').style.display = 'none';
        document.getElementById('stats-container').style.display = 'grid';
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        document.getElementById('stats-loading').style.display = 'none';
        document.getElementById('stats-error').textContent = 'åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error.message;
        document.getElementById('stats-error').style.display = 'block';
      }
    }

    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    async function loadUsers() {
      try {
        const response = await fetch('/api/users');
        
        if (!response.ok) {
          throw new Error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
        }
        
        const data = await response.json();
        
        if (!data.success || !data.users) {
          throw new Error('ç”¨æˆ·æ•°æ®æ ¼å¼é”™è¯¯');
        }
        
        // æ¸…ç©ºè¡¨æ ¼
        const tbody = document.getElementById('users-tbody');
        tbody.innerHTML = '';
        
        // æ·»åŠ ç”¨æˆ·æ•°æ®
        data.users.forEach(user => {
          const tr = document.createElement('tr');
          
          // æ ¼å¼åŒ–æ—¥æœŸ
          const createdAt = user.created_at ? new Date(user.created_at).toLocaleString() : 'æœªçŸ¥';
          const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString() : 'æœªçŸ¥';
          
          tr.innerHTML = `
            <td>${user.username}</td>
            <td>${user.balance}</td>
            <td>${user.is_admin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</td>
            <td>${createdAt}</td>
            <td>${lastLogin}</td>
          `;
          
          tbody.appendChild(tr);
        });
        
        // éšè—åŠ è½½æç¤ºï¼Œæ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
        document.getElementById('users-loading').style.display = 'none';
        document.getElementById('users-container').style.display = 'block';
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('users-loading').style.display = 'none';
        document.getElementById('users-error').textContent = 'åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message;
        document.getElementById('users-error').style.display = 'block';
      }
    }

    // åŠ è½½æ¸¸æˆè®°å½•
    async function loadGameRecords() {
      try {
        const response = await fetch('/api/game_records');
        
        if (!response.ok) {
          throw new Error('è·å–æ¸¸æˆè®°å½•å¤±è´¥');
        }
        
        const data = await response.json();
        
        if (!data.success || !data.records) {
          throw new Error('æ¸¸æˆè®°å½•æ ¼å¼é”™è¯¯');
        }
        
        // æ¸…ç©ºè¡¨æ ¼
        const tbody = document.getElementById('records-tbody');
        tbody.innerHTML = '';
        
        // æ·»åŠ æ¸¸æˆè®°å½•
        data.records.forEach(record => {
          const tr = document.createElement('tr');
          
          // æ ¼å¼åŒ–æ—¥æœŸ
          const createdAt = record.created_at ? new Date(record.created_at).toLocaleString() : 'æœªçŸ¥';
          
          // ç¿»è¯‘èŠ±è‰²
          const translateSuit = suit => {
            switch (suit) {
              case 'hearts': return 'çº¢æ¡ƒ';
              case 'diamonds': return 'æ–¹å—';
              case 'clubs': return 'æ¢…èŠ±';
              case 'spades': return 'é»‘æ¡ƒ';
              case 'joker': return 'å°ä¸‘';
              default: return suit;
            }
          };
          
          tr.innerHTML = `
            <td>${record.username}</td>
            <td>${translateSuit(record.bet_suit)}</td>
            <td>${translateSuit(record.result_suit)}</td>
            <td>${record.amount}</td>
            <td class="${record.win ? 'win' : 'lose'}">${record.win ? 'èµ¢' : 'è¾“'}</td>
            <td>${record.win_amount}</td>
            <td>${createdAt}</td>
          `;
          
          tbody.appendChild(tr);
        });
        
        // éšè—åŠ è½½æç¤ºï¼Œæ˜¾ç¤ºæ¸¸æˆè®°å½•
        document.getElementById('records-loading').style.display = 'none';
        document.getElementById('records-container').style.display = 'block';
      } catch (error) {
        console.error('åŠ è½½æ¸¸æˆè®°å½•å¤±è´¥:', error);
        document.getElementById('records-loading').style.display = 'none';
        document.getElementById('records-error').textContent = 'åŠ è½½æ¸¸æˆè®°å½•å¤±è´¥: ' + error.message;
        document.getElementById('records-error').style.display = 'block';
      }
    }

    // ç™»å‡º
    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST' });
        window.location.href = '/login.html';
      } catch (error) {
        console.error('ç™»å‡ºå¤±è´¥:', error);
        alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
  </script>
</body>
</html>